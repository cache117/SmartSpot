<html>
<head>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" href="stylesheets/style.css" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <stript type="text/javascript" src="javascripts/app.js"></stript>
    <script>

        var g_access_token = '';
        var g_username = '';
        var g_tracks = [];
        var g_name = '';

        function getUsername(callback) {
            console.log('getUsername');
            var url = 'https://api.spotify.com/v1/me';
            $.ajax(url, {
                dataType: 'json',
                headers: {
                    'Authorization': 'Bearer ' + g_access_token
                },
                success: function(r) {
                    console.log('got username response', r);
                    callback(r.id);
                },
                error: function(r) {
                    callback(null);
                }
            });
        }

        function buildPlaylist(username, name, callback) {
            console.log('buildPlaylist', username, name);
            var url = 'https://api.spotify.com/v1/users/' + username +
                    '/playlists';
            $.ajax(url, {
                method: 'POST',
                data: JSON.stringify({
                    'name': name,
                    'public': false
                }),
                dataType: 'json',
                headers: {
                    'Authorization': 'Bearer ' + g_access_token,
                    'Content-Type': 'application/json'
                },
                success: function(r) {
                    console.log('create playlist response', r);
                    callback(r.id);
                },
                error: function(r) {
                    callback(null);
                }
            });
        }

        function addTracksToPlaylist(username, playlist, tracks, callback) {
            console.log('addTracksToPlaylist', username, playlist, tracks);
            var url = 'https://api.spotify.com/v1/users/' + username +
                    '/playlists/' + playlist +
                    '/tracks'; // ?uris='+encodeURIComponent(tracks.join(','));
            $.ajax(url, {
                method: 'POST',
                data: JSON.stringify(tracks),
                dataType: 'text',
                headers: {
                    'Authorization': 'Bearer ' + g_access_token,
                    'Content-Type': 'application/json'
                },
                success: function(r) {
                    console.log('add track response', r);
                    callback(r.id);
                },
                error: function(r) {
                    callback(null);
                }
            });
        }

        function doit() {
            // parse hash
            var hash = location.hash.replace(/#/g, '');
            var all = hash.split('&');
            var args = {};
            console.log('all', all);
            all.forEach(function(keyvalue) {
                var idx = keyvalue.indexOf('=');
                var key = keyvalue.substring(0, idx);
                var val = keyvalue.substring(idx + 1);
                args[key] = val;
            });

            g_name = sessionStorage.getItem('SmartSpot-name');
            g_tracks = JSON.parse(sessionStorage.getItem('SmartSpot-tracks'));

            console.log('got args', args);

            if (typeof(args['access_token']) != 'undefined') {
                // got access token
                console.log('got access token', args['access_token']);
                g_access_token = args['access_token'];
            }

            getUsername(function(username) {
                console.log('got username', username);
                buildPlaylist(username, g_name, function(playlist) {
                    console.log('created playlist', playlist);
                    addTracksToPlaylist(username, playlist, g_tracks, function() {
                        console.log('tracks added.');
                        username = 'cache117';
                        playlist = '0SGVg26tbs6M2hSBc3ghIK';
                        $('#playlistlink').attr('href', 'spotify:user:'+username+':playlist:'+playlist);
                        $('#creating').hide();
                        $('#done').show();
                    });
                });
            });
        }

    </script>
</head>
<body onload="doit()" ng-controller="CreationCtrl" ng-init="createPlaylist()">
<div class="site-wrapper">
    <div class="site-wrapper-inner">
        <div id="creating" style="text-align: center;">
            <h1>Creating playlist...</h1>
        </div>
        <div id="done" style="display: none; text-align: center;">
            <h1>Done!</h1>
            <p>
                <a class="btn btn-lg btn-primary btn-success" id="playlist-link">
                    Open playlist in Spotify
                </a>
            </p>
        </div>
    </div>
</div>
</body>
</html>